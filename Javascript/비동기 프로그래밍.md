# 비동기 프로그래밍

<br>

## 🧐동기 프로그래밍 이란?

<br>

자바스크립트 엔진은 단 하나의 실행 컨텍스트 스택을 갖는다.

함수를 실행할 수 있는 방법은 단 하나이며, 동시에 2개 이상의 함수를 동시에 실행 할 수 없다.

<br>

실행 컨텍스트 스택에서 실행중인 실행 컨텍스트가 팝되어야지 다음 실행 컨텍스트가 실행할 수 있다.

<br>

이렇게 자바스크립트은 싱글 스레드 방식으로 동작한다.

<br>

따라서 처리하는데 시간이 걸리는 태스크는 다음 태스크가 기다리는 블로킹이 일어난다.

<br>

다음 실행 태스크가 대기하는 방식을 **동기 처리 방식**이라고 한다.

<br>

## 🧐 비동기 프로그래밍 이란?

<br>

**비동기 처리방식**은 현재 실행 중인 태스크가 종료되지 않은 상태라 해도 다음 태스크를 곧바로 실행하는 방식을 말한다.

<br>

## 🆚 동기 vs 비동기 비교

<br>

### 동기 프로그래밍 장단점

<br>

장점

- 태스크를 순서대로 하나씩 처리하므로 **실행 순서 보장**되어 코드를 설계하기 수월하다

단점

- 앞의 태스크가 종료될 때까지 이후 **태스크들이 블로킹** 되어 실행 시간이 걸린다는 단점

<br>

### 비동기 프로그래밍 장단점

<br>

장점

- 현재 실행 중인 태스크가 종료되지 않아도 다음 태스크를 곧바로 실행해서 **블로킹이 발생하지 않는 다는 실행 장점**

단점

- **태스크 실행 순서**가 보장되지 않는 단점
- 비동기 처리는 일반적으로 **콜백 패턴**을 사용

  → 비동기 처리를 위한 콜백 패턴은 콜백 헬을 발생 시켜 **가독성**이 나쁨

  → **에러의 예외 처리가 힘듬**

<br>

setTimeout, setInterval, HTTP 요청, 이벤트 핸들러는 비동기 처리방식 으로 동작

<br>

이러한 비동기 처리방식은 자바스크립트 엔진이만이 처리하는것이 아니라 브라우저와 함께 처리 하게된다.

<br>

## 이벤트 루프와 태스크 큐

<br>

자바스크립트에서 함수가 실행되었을때 생겨지는 실행컨텍스트는 실행컨텍스트 스택에 쌓이게된다.

<br>

이 실행컨텍스트 스택이 바로 자바스크립트 엔진에서 콜 스택이라고 한다.

<br>

### 콜 스택

함수가 호출되면 이곳에서 실행컨텍스트가 추가되고 제거가 된다.

<br>

### 태스크 큐

setTimeout이나 setInterval과 같은 비동기 함수의 콜백 함수 또는 이벤트 핸들러와 같은 비동기 함수는 콜스택이 아니라 브라우저의 태스크 큐에 쌓이게 된다.

<br>

태스크 큐에 쌓이는 비동기 함수들은 브라우저의 이벤트 루프에 의해서 지속적으로 콜 스택과 태스크 큐를 확인한다.

<br>

### 이벤트 루프

<br>

이벤트 루프는 브라우저에 의해서 동작합니다.

<br>

지속적으로 콜 스택과 태스크 큐를 비교를 하고 만약 콜 스택에 더이상 실행 컨텍스트가 없다면,

즉 , 비어있다면 그때서 태스크 큐에 쌓여있는 비동기 함수들을 가장 밑에서 부터 차례대로 불러와 콜 스택에 하나씩 쌓아 넣게 된다.

<br>

그때 이 콜 스택에 비동기 함수가 처리되어 지고 다시 비어지게 되면

그 다음 태스크 큐의 가장 밑의 비동기 함수가 이동되서 실행된다.

<br>

### 마이크로 태스크큐

<br>

브라우저의 태스크큐는 setTimeout이나 setInterval과 같은 비동기 함수의 콜백 함수 또는 이벤트 핸들러와같은 비동기 함수가 저장된다면

<br>

마이크로 태스크큐는 오로지 프로미스의 후속 처리 메서드만 저장되어 진다.

<br>

마이크로 태스크 큐는 태스크 큐보다 우선순위가 높다.

<br>

이벤트 루프는 지속적으로 콜 스택이 비어지면 먼저 마이크로 태스크큐에 대기하고 있는 함수가 있는지 확인하고 먼저 실행한다.

<br>

이후에 마이크로 태스크 큐가 비어지면 태스크 큐에서 대기하고 있는 함수를 실행한다.

<br>

## 브라우저 멀티 스레드 방식

<br>

이처럼 자바스크립트는 콜 스택인 싱글 스레드 방식으로 동작을 한다.

<br>

하지만 이때 싱글 스레드로 동작하는것은 브라우저가 아니라 브라우저에 내장된 자바스크립트 엔진이라는 것이다.

따라서 자바스크립트 엔진은 싱글 스레드로 동작하지만 브라우저는 멀티 스레드로 동작한다.

<br>

이렇게 브라우저와 자바스크립트 엔진이 협력하면서 비동기 함수를 실행한다.

<br>

## 정리

- 콜스택 → 실행컨텍스트 스택

  ⇒ 함수가 실행되면 쌓임

  ⇒ 최상위 실행컨텍스트가 실행중인 컨텍스트, 종료되면 콜 스택 제거

- 힙

  ⇒ 객체가 저장되는 메모리 공간

  ⇒ 콜 스택이 힙을 참조

- 태스크 큐

  ⇒ 비동기 함수의 콜백함수 또는 이벤트 핸들러가 일시적으로 보관되는곳

- 이벤트 루프

  ⇒ 콜 스택 과 태스크 큐를 계속해서 확인

  ⇒ 비어있으면 태스크큐를 콜스택으로 이동시킴

- 마이크로태스크 큐

  ⇒ 우선순위 : 마이크로 태스크큐 > 태스크큐

  ⇒ 프로미스 후속 메서드의 콜백함수

<br>

참고

- [모던 자바스크립트 Deep Dive](http://www.yes24.com/Product/Goods/92742567)
